services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - mode: ingress
        target: 8000
    environment:
      # Database Configuration
      DATABASE_URL: 
      # JWT Configuration
      JWT_SECRET: 
      JWT_EXPIRES_MINUTES: "10080"
      
      # Admin Panel Secret
      ADMIN_SECRET_KEY:
      
      # OpenAI API Key
      OPENAI_API_KEY: 
      
      # Redis Configuration
      # Railway Redis URL configured via environment variable
      REDIS_URL: ${REDIS_URL:-redis://localhost:6379/0}
      
      # CORS Configuration - allow both versions
      BACKEND_CORS_ORIGINS: "https://t8zgrthold5r2-frontend--3000.prod1.defang.dev"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        reservations:
          memory: 512M

  frontend:
    build:
      context: ./ui
      dockerfile: Dockerfile
      args:
        # Backend URL passed at build time for Next.js
        NEXT_PUBLIC_API_BASE: https://t8zgrthold5r2-backend--8000.prod1.defang.dev
    ports:
      - mode: ingress
        target: 3000
    environment:
      # Backend API URL
     
      NEXT_PUBLIC_API_BASE: https://t8zgrthold5r2-backend--8000.prod1.defang.dev
      NODE_ENV: production
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 20s
    depends_on:
      - backend
    deploy:
      resources:
        reservations:
          memory: 512M
